pipeline {

	agent none
	
	environment {
		MAVEN_OPTS = "-Dmaven.repo.local=${env.WORKSPACE}/.m2"
		DOCKER_IMAGE = "combarim/todo-app"
		DOCKER_HOST = 'tcp://host.docker.internal:2375'

	}

	stages {

		stage('Checkout') {
			agent any
			steps {
				sh '''
				if [ -d jenkins-todo-app ]; then
					cd jenkins-todo-app && git pull
				else 
					git clone https://github.com/combarim/jenkins-todo-app.git
				fi
				'''
			}
		}

		stage('Build & Test') {
			agent any
			steps {
				dir('backend') {
					sh 'chmod +x ./mvnw'
					sh './mvnw clean package'
				}
			}
			post {
				success {
					echo "Build et tests réussis"
				}
				failure {
					echo "Erreur lors du build ou des tests"
				}
			}
		}

		stage('Docker build & Push') {
			agent any
			steps  {
				dir('backend') {
					script {
						def commitHash = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
						def tag = "${DOCKER_IMAGE}:${commitHash}"
						def latestTag = "${DOCKER_IMAGE}:latest"
						sh "docker build -t ${tag} ."
						sh "docker tag ${tag} ${latestTag}"

						withCredentials([usernamePassword(credentialsId: 'dockerhub-credentials', usernameVariable: 'DOCKERHUB_USER', passwordVariable: 'DOCKERHUB_PASSWORD')]){
							sh 'echo $DOCKERHUB_PASSWORD | docker login -u $DOCKERHUB_USER --password-stdin'
							sh "docker push $tag"
							sh "docker push $latestTag"
						}
					}
				}
			}
			post {
				success {
					echo "Docker image construite avec succès"
				}
				failure {
					echo "Erreur lors de la construction de l'image Docker"
				}
			}
		}

	}

	post {
		always {
			echo "Pipeline CI/CD terminé"
		}
	}

}